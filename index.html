<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SISTEM KOD JAWI - Panduan DBP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-deep: #0f1115;
      --bg-card: #181b21;
      --bg-elevated: #22262e;
      --fg: #eaecf0;
      --fg-muted: #8b929c;
      --accent: #e5a740;
      --accent-dim: rgba(229, 167, 64, 0.15);
      --border: #2e333d;
      --success: #4ade80;
      --negative: #f87171;
      --info: #60a5fa;
    }

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
      font-family: 'IBM Plex Sans', sans-serif;
      background-color: var(--bg-deep);
      color: var(--fg);
      line-height: 1.6;
      min-height: 100vh;
    }

.font-jawi { font-family: 'Amiri', serif; direction: rtl; }

.bg-texture {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-color: var(--bg-deep);
      background-image: 
        radial-gradient(circle at 100% 0%, rgba(229, 167, 64, 0.08) 0%, transparent 25%),
        radial-gradient(circle at 0% 100%, rgba(229, 167, 64, 0.05) 0%, transparent 25%);
    }

.card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

.input-main {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      color: var(--fg);
      font-size: 1.125rem;
      transition: all 0.2s;
      outline: none;
    }

.input-main:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

.btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.75rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
      font-size: 1rem;
    }

.btn-primary {
      background: linear-gradient(135deg, var(--accent), #d4922e);
      color: #000;
      box-shadow: 0 4px 14px rgba(229, 167, 64, 0.25);
    }

.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(229, 167, 64, 0.4); }

.tag {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      background: var(--accent-dim);
      color: var(--accent);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

.status-pill {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-local { background: rgba(96, 165, 250, 0.15); color: var(--info); }
    .status-api { background: rgba(74, 222, 128, 0.15); color: var(--success); }

.result-box {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
    }

.breakdown-item {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 0.875rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .breakdown-item:hover { border-color: var(--border); background: rgba(255,255,255,0.05); }
    .breakdown-item .char { width: 40px; text-align: center; font-size: 1.75rem; color: var(--accent); }

.spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(0,0,0,0.1);
      border-left-color: #000;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

.data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    .data-table th { color: var(--fg-muted); font-weight: 500; font-size: 0.7rem; text-transform: uppercase; }
    .data-table td:first-child { font-size: 1.25rem; text-align: center; width: 50px; }

</style>
</head>
<body>

<div class="bg-texture"></div>

<div class="max-w-6xl mx-auto px-4 py-8">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold mb-2 tracking-tight">SISTEM KOD JAWI</h1>
      <p class="text-gray-400">Transliterasi & Pengkodan Jawi Precise</p>
    </header>

<div class="grid md:grid-cols-3 gap-6">

<div class="md:col-span-2 space-y-6">

<!-- Input Card -->
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Input Teks</h2>
            <div class="flex items-center gap-2">
              <span id="statusBadge" class="tag hidden">Positif</span>
              <span id="apiStatus" class="status-pill status-local">Engine Lokal</span>
            </div>
          </div>

<div class="relative mb-4">
            <input type="text" id="inputRumi" class="input-main pr-20" placeholder="Cth: haram, halal, iman..." oninput="handleRumiInput(event)">
            <div id="loadingSpinner" class="absolute right-4 top-4 hidden"><div class="spinner"></div></div>
          </div>

<div class="flex items-center justify-between text-xs text-gray-500 mb-2">
             <span>Paparan Jawi</span>
             <span id="engineUsed">Sumber: Enjin Dalaman</span>
          </div>
          <div id="previewJawi" class="input-main font-jawi text-2xl min-h-60px flex items-center justify-end border-dashed border-gray-600">
            <span class="text-gray-600" style="direction: ltr; font-family: 'IBM Plex Sans'; font-size: 0.9rem;">Sila taip...</span>
          </div>

<div class="flex items-center justify-between mt-5 pt-4 border-t border-gray-700">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="checkNegative" class="w-4 h-4 accent-amber-500 cursor-pointer">
              <label for="checkNegative" class="text-sm text-gray-400 cursor-pointer">Kata Negatif</label>
            </div>
            <button class="btn btn-primary" onclick="processText()">
              <span>Jana Kod</span>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
          </div>
        </div>

<!-- Output Card -->
        <div class="card">
          <h2 class="text-lg font-semibold mb-3">Hasil Kod</h2>
          <div id="resultContainer" class="result-box">
            <p class="text-gray-500 italic text-sm">Keputusan akan dipaparkan di sini.</p>
          </div>
          <div id="breakdownContainer" class="mt-5 hidden">
            <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-widest">Pecahan Analisis</h3>
            <div id="breakdownList"></div>
          </div>
        </div>

</div>

<!-- Sidebar -->
      <div class="space-y-6">

<!-- History -->
        <div class="card">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Sejarah</h3>
            <button class="text-xs text-gray-500 hover:text-red-400 transition" onclick="clearHistory()">Padam</button>
          </div>
          <div id="historyList" class="space-y-2 max-h-32 overflow-y-auto text-sm">
            <p class="text-gray-600 italic text-xs">Tiada rekod</p>
          </div>
        </div>

<!-- Kod Table -->
        <div class="card">
          <h3 class="font-semibold mb-3">Jadual Rujukan</h3>
          <input type="text" class="input-main text-xs mb-3 py-2" placeholder="Cari kod..." oninput="filterTable(this.value)">
          <div class="overflow-y-auto max-h-80" style="overscroll-behavior: contain;">
            <table class="data-table">
              <thead>
                <tr><th>Huruf</th><th>Kod</th></tr>
              </thead>
              <tbody id="kodTableBody"></tbody>
            </table>
          </div>
        </div>

</div>
    </div>
  </div>

<script>
    // ================= DATA & KONFIGURASI =================
    const KOD_JAWI = {
      'ا': 'Aturan', 'ب': 'Dasar', 'ت': 'Sistem rangkaian', 'ث': 'Hubungan',
      'ج': 'Sumber', 'چ': 'Sumber dengan sifat', 'ح': 'Sifat', 'خ': 'Pentadbiran',
      'د': 'Hasil', 'ذ': 'Pengampunan', 'ر': 'Yakin', 'ز': 'Mentauhidkan aturan',
      'س': 'Prinsip', 'ش': 'Penegasan', 'ص': 'Sikap', 'ض': 'Pengurusan sumber tenaga',
      'ط': 'Kaedah pengurusan', 'ظ': 'Imbas', 'ع': 'Strategi', 'غ': 'Teknologi',
      'ڠ': 'Teknologi pengurusan', 'ف': 'Kaedah pengurusan mentauhidkan dasar',
      'ڤ': 'Kaedah pengurusan mentauhidkan hasil', 'ق': 'Mentauhidkan dasar',
      'ک': 'Kefahaman pengurusan modal insan', 'ݢ': 'Kefahaman pengurusan sumber tenaga',
      'ل': 'Orang-orang yang beriman', 'م': 'Pedoman', 'ن': 'Pembeza',
      'و': 'Jelas', 'ۏ': 'Jelas berjemaah', 'ه': 'Jemaah', 'لا': 'Cerita-cerita',
      'ء': 'Muslihat', 'ي': 'Tanda-tanda kejayaan', 'ڽ': 'Mentauhidkan kejayaan sistem rangkaian'
    };

    const NEGATIVE_WORDS = ['munafik', 'haram', 'zalim', 'kafir', 'fasik', 'keji', 'jadah', 'sombong'];
    
    // Mapping untuk transliterasi fallback
    const CONS_MAP = { 'b':'ب', 'c':'چ', 'd':'د', 'f':'ف', 'g':'ݢ', 'h':'ه', 'j':'ج', 'k':'ک', 'l':'ل', 'm':'م', 'n':'ن', 'p':'ڤ', 'q':'ق', 'r':'ر', 's':'س', 't':'ت', 'v':'ۏ', 'w':'و', 'x':'کس', 'y':'ي', 'z':'ز' };
    const CONS_CLUSTER = { 'ng':'ڠ', 'ny':'ڽ', 'sy':'ش', 'kh':'خ', 'gh':'غ', 'dz':'ذ', 'ts':'ث' };
    const API_URL = 'https://ebayt.muip.gov.my/jawi/libjawi.php';

    // ================= STATE =================
    let historyData = [];
    let debounceTimer = null;
    let currentJawiResult = '';

    // ================= INISIALISASI =================
    document.addEventListener('DOMContentLoaded', () => {
      window.elInputRumi = document.getElementById('inputRumi');
      window.elPreviewJawi = document.getElementById('previewJawi');
      window.elResult = document.getElementById('resultContainer');
      window.elBreakdown = document.getElementById('breakdownContainer');
      window.elBreakdownList = document.getElementById('breakdownList');
      window.elStatus = document.getElementById('statusBadge');
      window.elHistory = document.getElementById('historyList');
      window.elTableBody = document.getElementById('kodTableBody');
      window.elApiStatus = document.getElementById('apiStatus');
      window.elLoading = document.getElementById('loadingSpinner');
      window.elEngineInfo = document.getElementById('engineUsed');
      
      renderKodTable('');
      loadHistory();
    });

    // ================= LOGIC TRANSLITERASI (RUMI -> JAWI) =================
    async function getJawiText(rumiText) {
      const apiResult = await tryApiFetch(rumiText);
      if (apiResult) {
        updateApiStatus('api');
        return apiResult;
      }
      updateApiStatus('local');
      return localTransliterate(rumiText);
    }

    async function tryApiFetch(text) {
      try {
        const url = `${API_URL}?rumi=${encodeURIComponent(text)}&vajawi=&_=${Date.now()}`;
        const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
        const rawText = await response.text();
        try {
          const data = JSON.parse(rawText);
          if (data && data.jawi) return data.jawi;
        } catch (e) {
          if (rawText && rawText.trim()) return rawText.trim();
        }
        return null;
      } catch (e) { return null; }
    }

    function localTransliterate(text) {
      if (!text) return '';
      text = text.toLowerCase().trim();
      return text.split(/\s+/).map(word => {
        let result = ''; let i = 0; const len = word.length;
        while (i < len) {
          const c = word[i]; const next = word[i+1] || ''; const next2 = word[i+2] || '';
          // Awal Vokal
          if (i === 0 && 'aiueo'.includes(c)) {
            if (c === 'a') result += 'ا'; else if (c === 'i') result += 'اي'; else if (c === 'u') result += 'او';
            else if (c === 'e') result += 'اي'; else result += 'او'; i++; continue;
          }
          // Gandingan
          if (CONS_CLUSTER[c+next]) { result += CONS_CLUSTER[c+next]; i+=2; continue; }
          // Konsonan + Vokal Logic
          if (CONS_MAP[c]) {
            if (next === 'a') {
              const charAfterA = next2; const isEnd = (i+2 >= len);
              if (isEnd) { result += CONS_MAP[c] + 'ا'; i+=2; continue; }
              if (CONS_MAP[charAfterA] || CONS_CLUSTER[next2+word[i+3]]) { result += CONS_MAP[c]; i+=2; continue; }
              result += CONS_MAP[c] + 'ا'; i+=2; continue;
            }
            if ('iueo'.includes(next)) {
              const vMap = { 'i':'ي', 'u':'و', 'e':'ي', 'o':'و' };
              result += CONS_MAP[c] + vMap[next]; i+=2; continue;
            }
            result += CONS_MAP[c]; i++;
          } else { result += c; i++; }
        }
        return result;
      }).join(' ');
    }

    function updateApiStatus(status) {
      if (!elApiStatus) return;
      if (status === 'api') {
        elApiStatus.className = 'status-pill status-api';
        elApiStatus.textContent = 'API Muip';
        if(elEngineInfo) elEngineInfo.textContent = "Sumber: API MUIP";
      } else {
        elApiStatus.className = 'status-pill status-local';
        elApiStatus.textContent = 'Engine Lokal';
        if(elEngineInfo) elEngineInfo.textContent = "Sumber: Enjin Dalaman";
      }
    }

    // ================= LOGIC PENGKODAN (JAWI -> KOD) =================
    // Implementasi logik baru berdasarkan prompt doc

    function kodkanWord(word, isNeg) {
      let parts = [];
      let breakdown = [];
      let i = 0;
      let len = word.length;
      let prefix = isNeg ? 'Tiada punyai ' : 'Punyai ';

      // Helper functions
      const addPart = (text, h, k, t) => {
        parts.push(text);
        breakdown.push({ huruf: h, kod: k, type: t });
      };

      while (i < len) {
        let char = word[i];
        let next = word[i + 1] || '';
        let nextNext = word[i + 2] || '';
        let prev = word[i - 1] || '';

        // 1. SPECIAL PATTERNS (Priority)
        // Pattern: نيا
        if (char === 'ن' && next === 'ي' && nextNext === 'ا') {
          addPart('dikuasai oleh pembeza yang ada tanda-tanda kejayaan dengan adanya aturan', 'نيا', 'Pola Khas نيا', 'Pola Khas');
          i += 3; continue;
        }
        // Pattern: ري
        if (char === 'ر' && next === 'ي') {
          addPart('dikuasai oleh keyakinan yang ada tanda-tanda kejayaan', 'ري', 'Pola Khas ري', 'Pola Khas');
          i += 2; continue;
        }
        // Pattern: ڽيا, قيا, زيا
        if ((char === 'ڽ' || char === 'ق' || char === 'ز') && next === 'ي' && nextNext === 'ا') {
          let k = KOD_JAWI[char];
          addPart(`demi ${k.toLowerCase()} yang ada tanda-tanda kejayaan untuk diatur/mengatur`, char+'يا', 'Pola Khas', 'Pola Khas');
          i += 3; continue;
        }
        // Pattern: عاء
        if (char === 'ع' && next === 'ا' && nextNext === 'ء') { // عاء usually involves hamza?
           // Prompt says: Gabungan عاء
           // Jawi spelling: عاء. chars: ع, ا, ء.
           // Checking char='ع', next='اء'? No, next is 'ا'.
           // Prompt: "Gabungan عاء -> strategi untuk diatur/mengatur berlandaskan muslihat"
           // Let's check strictly for ع followed by ا and ء
           if (next === 'ا' && nextNext === 'ء') {
             addPart('strategi untuk diatur/mengatur berlandaskan muslihat', 'عاء', 'Pola Khas عاء', 'Pola Khas');
             i += 3; continue;
           }
        }

        // Pattern: لا (Lam Alif)
        if (char === 'ل' && next === 'ا') {
          addPart('cerita-cerita', 'لا', 'Cerita-cerita', 'Pola Khas');
          // Check if followed by another char (e.g. حلال)
          if (nextNext && KOD_JAWI[nextNext]) {
            addPart(`dengan adanya ${KOD_JAWI[nextNext].toLowerCase()}`, nextNext, KOD_JAWI[nextNext], 'Sambungan LA');
            i += 3; // Skip LA + Next
          } else {
            i += 2;
          }
          continue;
        }

        // 2. ALIF (ا) RULES
        if (char === 'ا') {
          // Initial Position
          if (i === 0) {
            if (next === 'ي') {
              addPart('dikuasai oleh aturan yang ada tanda-tanda kejayaan', 'اي', 'Alif+Ya Awal', 'Kombinasi');
              i += 2;
            } else if (next && KOD_JAWI[next]) {
              addPart(`aturan berkaitan ${KOD_JAWI[next].toLowerCase()}`, 'ا'+next, 'Alif+Konsonan', 'Kombinasi');
              i += 2; // Skip next consonant
            } else {
              addPart('aturan', 'ا', 'Aturan', 'Biasa');
              i++;
            }
          } 
          // Middle Position
          else if (i < len - 1) {
            if (next === 'ل') {
              addPart('untuk diatur/mengatur melalui orang-orang yang beriman', 'ا+ل', 'Alif+Lam', 'Kombinasi');
              i += 2;
            } else if (next === 'ڽ' || next === 'ق' || next === 'ز') {
              let k = KOD_JAWI[next];
              addPart(`untuk diatur/mengatur demi ${k.toLowerCase()}`, 'ا+'+next, 'Alif+Khas', 'Kombinasi');
              i += 2;
            } else if (next && KOD_JAWI[next]) {
              let k = KOD_JAWI[next];
              addPart(`untuk diatur/mengatur berlandaskan ${k.toLowerCase()}`, 'ا', 'Alif Tengah', 'Kombinasi');
              i += 2; // Skip next consonant
            } else {
              addPart('aturan', 'ا', 'Aturan', 'Biasa');
              i++;
            }
          }
          // End Position
          else {
            addPart('dengan adanya aturan', 'ا', 'Alif Hujung', 'Posisi');
            i++;
          }
          continue;
        }

        // 3. YA (ي) RULES
        if (char === 'ي') {
          // Initial
          if (i === 0) {
            addPart('tanda-tanda kejayaan', 'ي', 'Tanda-tanda kejayaan', 'Biasa');
            i++;
          } 
          // Standalone Ya (rarely happens in middle if not part of pattern, usually treated as ending)
          else {
             addPart('tanda-tanda kejayaan', 'ي', 'Tanda-tanda kejayaan', 'Biasa');
             i++;
          }
          continue;
        }

        // 4. NUN (ن) RULES
        if (char === 'ن') {
          if (next === 'ا') {
            addPart('pembeza dengan adanya aturan', 'ن+ا', 'Nun+Alif', 'Kombinasi');
            i += 2;
          } else if (next === 'و') {
            addPart('pembeza yang jelas', 'ن+و', 'Nun+Wau', 'Kombinasi');
            i += 2;
          } else if (next === 'ي') {
            // Note: نيا handled earlier
            addPart('dikuasai oleh pembeza yang ada tanda-tanda kejayaan', 'ن+ي', 'Nun+Ya', 'Kombinasi');
            i += 2;
          } else if (i === len - 1) {
            addPart('dengan adanya pembeza', 'ن', 'Nun Hujung', 'Posisi');
            i++;
          } else {
            addPart('pembeza', 'ن', 'Pembeza', 'Biasa');
            i++;
          }
          continue;
        }

        // 5. RA (ر) RULES
        if (char === 'ر') {
          // Special Logic for 'haram' case (Ra followed by Alif -> Keyakinan, but Alif processed next)
          // General Logic: Ra in middle -> Yang diyakini.
          // Exception found in test case: haram -> keyakinan.
          // Let's assume 'Ra' followed by 'Alif' acts like initial 'Keyakinan'?
          // Or Ra is always Keyakinan unless specific rules?
          // Prompt: "Jika dipunyai oleh huruf lain -> ... yang diyakini"
          // BUT Test Case `haram` -> `keyakinan`.
          // Let's check if followed by Alif.
          if (next === 'ا') {
             addPart('keyakinan', 'ر', 'Keyakinan', 'Posisi'); 
             // DO NOT SKIP ALIF. Let Alif handle itself next.
             i++;
          } else if (i === 0) {
            addPart('keyakinan', 'ر', 'Keyakinan', 'Posisi');
            i++;
          } else {
            addPart('yang diyakini', 'ر', 'Yang diyakini', 'Posisi');
            i++;
          }
          continue;
        }

        // 6. HA (ه) RULES
        if (char === 'ه') {
          if (i === len - 1) {
            addPart('terikat dengan adanya jemaah', 'ه', 'Terikat jemaah', 'Posisi');
          } else {
            addPart('jemaah', 'ه', 'Jemaah', 'Biasa');
          }
          i++;
          continue;
        }

        // 7. DEFAULT CONSONANT RULES & HURUF + YA
        if (KOD_JAWI[char]) {
          // Check for Huruf + Ya at end of word
          if (next === 'ي' && (i === len - 2)) {
            let k = KOD_JAWI[char];
            addPart(`dikuasai oleh ${k.toLowerCase()} yang ada tanda-tanda kejayaan`, char+'ي', 'Huruf+Ya', 'Kombinasi');
            i += 2;
          } else {
            addPart(KOD_JAWI[char].toLowerCase(), char, KOD_JAWI[char], 'Biasa');
            i++;
          }
          continue;
        }

        // Fallback
        i++;
      }

      return {
        output: prefix + parts.join(', '),
        breakdown: breakdown
      };
    }

    // ================= EVENT HANDLERS =================
    
    async function handleRumiInput(e) {
      const val = e.target.value;
      clearTimeout(debounceTimer);
      
      if (!val) {
        elPreviewJawi.innerHTML = "<span class=\"text-gray-600\" style=\"direction: ltr; font-family: 'IBM Plex Sans'; font-size: 0.9rem;\">Sila taip...</span>";
        currentJawiResult = '';
        return;
      }

      elLoading.classList.remove('hidden');
      elPreviewJawi.style.opacity = 0.5;

      debounceTimer = setTimeout(async () => {
        currentJawiResult = await getJawiText(val);
        elPreviewJawi.textContent = currentJawiResult;
        elPreviewJawi.style.opacity = 1;
        elLoading.classList.add('hidden');
      }, 300);
    }

    function processText() {
      const rumiInput = elInputRumi.value;
      const jawiText = currentJawiResult || localTransliterate(rumiInput);
      
      if (!jawiText.trim()) return;

      const isNeg = document.getElementById('checkNegative').checked || 
                    NEGATIVE_WORDS.some(w => rumiInput.toLowerCase().includes(w));

      const words = jawiText.trim().split(/\s+/);
      let fullResult = [];
      let allBreakdown = [];

      words.forEach(w => {
        const res = kodkanWord(w, isNeg);
        fullResult.push(res.output);
        allBreakdown.push(...res.breakdown);
      });

      renderOutput(fullResult.join('. '), allBreakdown, isNeg);
      saveHistory(rumiInput, fullResult.join('. '));
    }

    // ================= UI & UTILS =================
    function renderOutput(text, breakdown, isNeg) {
      elResult.innerHTML = `<p class="text-lg leading-relaxed font-medium">${text}</p>`;
      
      elStatus.classList.remove('hidden');
      elStatus.textContent = isNeg ? 'Negatif' : 'Positif';
      elStatus.style.background = isNeg ? 'rgba(248, 113, 113, 0.15)' : 'var(--accent-dim)';
      elStatus.style.color = isNeg ? 'var(--negative)' : 'var(--accent)';

      if (breakdown.length > 0) {
        elBreakdown.classList.remove('hidden');
        elBreakdownList.innerHTML = breakdown.map(b => `
          <div class="breakdown-item">
            <span class="font-jawi char">${b.huruf}</span>
            <div class="flex-1">
              <div class="font-medium text-sm">${b.kod}</div>
              <div class="text-xs text-gray-500">${b.type}</div>
            </div>
          </div>
        `).join('');
      }
    }

    function renderKodTable(filter) {
      let html = '';
      Object.entries(KOD_JAWI).forEach(([h, k]) => {
        if (h === 'لا') return;
        if (filter && !k.toLowerCase().includes(filter.toLowerCase())) return;
        html += `<tr><td class="font-jawi">${h}</td><td>${k}</td></tr>`;
      });
      if (elTableBody) elTableBody.innerHTML = html;
    }
    function filterTable(v) { renderKodTable(v); }

    function saveHistory(inTxt, outTxt) {
      historyData.unshift({ in: inTxt, out: outTxt, t: new Date().toLocaleTimeString() });
      if (historyData.length > 5) historyData.pop();
      localStorage.setItem('jawiHist', JSON.stringify(historyData));
      renderHistory();
    }
    function loadHistory() {
      const s = localStorage.getItem('jawiHist');
      if (s) historyData = JSON.parse(s);
      renderHistory();
    }
    function renderHistory() {
      if (!elHistory) return;
      if (!historyData.length) {
        elHistory.innerHTML = '<p class="text-gray-600 italic text-xs">Tiada rekod</p>';
        return;
      }
      elHistory.innerHTML = historyData.map(h => `
        <div class="p-2 bg-black/20 rounded cursor-pointer hover:bg-black/40 transition mb-1" onclick="loadHist('${h.in}')">
          <div class="font-medium truncate text-sm">${h.in}</div>
          <div class="text-xs text-gray-500">${h.t}</div>
        </div>
      `).join('');
    }
    function loadHist(txt) {
      elInputRumi.value = txt;
      elInputRumi.dispatchEvent(new Event('input'));
    }
    function clearHistory() {
      historyData = [];
      localStorage.removeItem('jawiHist');
      renderHistory();
    }

  </script>
</body>
</html>
